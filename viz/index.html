<html>
  <head>
    <title>Simplify Bounding Boxes</title>
    
    <link href='https://www.mapbox.com/base/latest/base.css' rel='stylesheet' />
    <style>
    
    rect {
      fill:none;
      stroke:#91bfdb;
      stroke-width:5px;
      stroke-opacity:0.3;
    }
    
    path {
      fill:none;
      stroke:#fc8d59;
      stroke-width:1px;
      stroke-opacity:1;
    }
    
    </style>
    
    <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.js'></script>
    <script>module = {}</script>
    <script src='../index.js'></script>
    <script type='text/javascript'>
    
    function createRectangle(svg, x, y, width, height) {
      var r = svg.append('rect')
      .attr('x', x)
      .attr('y', y)
      .attr('width', width)
      .attr('height', height);
      
      return r;
    }
    
    
    function getRandomInRange(x0, x1) {
      return Math.random() * (x1 - x0) + x0;
    }
    
    
    function getRandomAnchor(points) {
      
      var nSegments = points.length - 1;
      var segmentIndex = ~~(getRandomInRange(0, nSegments));
      
      var p0 = points[segmentIndex];
      var p1 = points[segmentIndex + 1];
      
      var x0 = p0[0], y0 = p0[1];
      var x1 = p1[0], y1 = p1[1];
      
      var x = getRandomInRange(p0[0], p1[0]);
      var y = (y1 - y0) / (x1 - x0) * (x - x1) + y1;
      
      return {
        point: [x, y],
        index: segmentIndex
      };
    }
    
    
    function onDOM() {
      window.removeEventListener('DOMContentLoaded');
      
      var svg = d3.select('.svg').append('svg');
      var node = svg.node();
      var box = node.getBoundingClientRect();
      
      var width = box.width;
      var height = width * 2 / 3;
      
      svg
      .attr('width', width)
      .attr('height', height);
      
      var nPoints = 4;
      var points = [], x0 = 0, y0 = 0;
      for (var i = 0; i < nPoints; i++) {

        // Generate random rightward points
        var x0 = getRandomInRange(x0, width);
        var y = getRandomInRange(0, height);

        points.push([x0, y]);
      }
      
      var points = [[10, 10], [100, 100], [200, 200]];
      // var points = [[50, 100], [200, 100], [250, 100]];
      
      // var anchor = getRandomAnchor(points);
      // var anchor = {
      //   index: 0,
      //   point: [117.16546011157334, 100]
      // }
      
      var anchor = {
        index: 0,
        point: [81.52352363569662, 81.52352363569662]
      }
      
      // var labelLength = getRandomInRange(10, 20);
      var labelLength = 20;
      svg.append('circle')
      .attr('r', 4)
      .attr('cx', anchor.point[0])
      .attr('cy', anchor.point[1]);
      
      // Fill in DOM with point coordinates
      d3.select('ul.points')
      .selectAll('li')
      .data(points)
      .enter()
        .append('li')
        .text(function(p) {
          var text = '(' + p[0].toFixed(2) + ', ' + p[1].toFixed(2) + ')';
          return text;
        });
      
      svg.selectAll('circles')
        .data(points)
        .enter().append("circle")
        .style("stroke", "gray")
        .style("fill", "black")
        .attr("r", 2)
        .attr("cx", function(d) { return d[0]; })
        .attr("cy", function(d) { return d[1]; });
      
      var lineFunction = d3.svg.line()
        .x(function(p) { return p[0]; })
        .y(function(p) { return p[1]; })
        .interpolate('linear');
      
      var polyLine = svg.append('path')
          .attr('d', lineFunction(points))
      
      var bboxes = bboxifyLabel(points, anchor, labelLength).reduce(function(a, b) {
        return a.concat(b);
      });
      
      console.log("BBOXIFIED", bboxes);
      
      for (var i = 0; i < bboxes.length; i++) {
        var bbox = bboxes[i];
        createRectangle(svg, bbox.x, bbox.y, bbox.width, bbox.height);
      }
      
    }
    
    window.addEventListener('DOMContentLoaded', onDOM, false);
    
    </script>
    
  </head>
  
  <body>
    <div class='grid fill-light'>
      <div class='col12 clearfix'>
        <nav class='col3 pad2'>
          <ul class='points'></ul>
        </nav>
        <div class='col9 pad4 fill-white'>
          <h2>bboxify-labels</h2>
          <div class="svg"></div>
        </div>
      </div>
    </div>
  </body>
</html>